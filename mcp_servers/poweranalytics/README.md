# PowerAnalytics MCP Server

This MCP server enables an LLM to interact with **PowerAnalytics.jl** — a Julia package
for analyzing power system simulation results generated by PowerSimulations.jl.

PowerAnalytics runs locally via the Julia REPL (no remote API calls). The server provides
a dynamic agentic workflow: the LLM discovers the API at runtime, pulls detailed docs on
demand, writes its own Julia scripts, and executes them. No new Python code is needed for
new analysis tasks.

## Tools

| Tool | Description |
|------|-------------|
| `check_julia_environment` | Verify Julia is available and PowerAnalytics.jl can be loaded |
| `get_docstring` | Get the full Julia docstring for a specific symbol (function, type, etc.) |
| `run_julia_script` | Execute arbitrary Julia code |
| `list_result_files` | Discover simulation result files and saved outputs |
| `refresh_api_index` | Regenerate the API index from installed Julia packages (mid-session) |

## Resources

| URI | Description |
|-----|-------------|
| `poweranalytics://api-index` | Auto-generated one-line-per-symbol index of all PowerAnalytics.jl exports |
| `poweranalytics://component-types` | Auto-generated PowerSystems.jl component type hierarchy |

Resources are generated from the installed Julia packages by running `python generate_index.py`.
If the resource files don't exist, the server falls back to a static subset.

## Prompts

| Prompt | Description |
|--------|-------------|
| `analyze_simulation` | Master orchestration — the 7-step workflow with worked example |
| `julia_coding_guide` | Julia script structure, imports, DataFrame conventions, pitfalls |
| `julia_error_handling` | How to read errors, retry strategy, common PowerAnalytics pitfalls |
| `output_saving_conventions` | File naming, directory structure, when to save vs print |
| `results_presentation` | Units, precision, power systems context, summarization rules |

## Configuration

Set via environment variables or edit constants in `server.py`:

| Variable | Default | Description |
|----------|---------|-------------|
| `JULIA_EXECUTABLE` | `julia` | Path to Julia binary |
| `PA_PROJECT_PATH` | `.` | Julia project with PowerAnalytics.jl |
| `PA_RESULTS_DIR` | `.` | Default directory for simulation results |
| `PA_SCRIPT_TIMEOUT` | `300` | Max seconds for a Julia script to run |
| `PA_SYSIMAGE_PATH` | *(empty)* | Optional path to a precompiled Julia sysimage (see below) |

## Prerequisites

- **Julia** must be installed and available on PATH (or set `JULIA_EXECUTABLE`).
- **PowerAnalytics.jl** and its dependencies (PowerSystems.jl, PowerSimulations.jl, etc.)
  must be available in the target Julia project environment.

## Generating the API Index

After installing or updating PowerAnalytics.jl, generate the API index files:

```bash
cd /path/to/SIENNA-PA-MCP/mcp_servers/poweranalytics
python generate_index.py
```

This creates `resources/api_index.md` and `resources/component_types.md` from the
installed Julia packages. The server reads these at runtime. You can also call the
`refresh_api_index` tool mid-session to regenerate without restarting the server.

## Sysimage (latency optimisation)

Every MCP tool call launches a fresh Julia process. Julia's JIT compilation adds
~15-30 s of overhead to the first `using` statements. A **precompiled sysimage**
eliminates this cost, bringing per-call latency down to ~2-3 s.

### Build the sysimage

```bash
# Run from the Julia project root (where Project.toml lives):
cd /path/to/PowerAnalytics
julia --project=. /path/to/SIENNA-PA-MCP/mcp_servers/poweranalytics/build_sysimage.jl
```

This produces `pa_sysimage.so` (~500 MB-1 GB). Build time is 5-15 minutes.

### Activate the sysimage

Add `PA_SYSIMAGE_PATH` to the server's `env` block in `.vscode/mcp.json`:

```jsonc
"env": {
    "PA_SYSIMAGE_PATH": "/path/to/PowerAnalytics/pa_sysimage.so",
    ...
}
```

Restart the MCP server. Subsequent tool calls will use the sysimage automatically.
When packages are updated, rebuild the sysimage to stay in sync.

## How to run and use the MCP server

- Open the MCP extension in your editor and go to **MCP: List Servers**.
- Choose the **poweranalytics** server and click **Start Server** if it is not already running.
- If you modify any server code, select the server again and click **Restart Server**.

## Example usage

Ask: *"What is the capacity factor of each renewable generator?"*

The LLM will:
1. Check the Julia environment
2. Read the API index to find `calc_capacity_factor`
3. Read component types to identify `RenewableDispatch`
4. Get the docstring for `calc_capacity_factor`
5. Write and execute a Julia script
6. Save results to CSV and present a summary with MW values

No `calc_capacity_factor` tool was coded in Python — the LLM discovered it dynamically.

## Development notes

- Main server file: `server.py`
- Entry point: `main.py`
- Index generator: `generate_index.py`
- Tests: `tests/test_poweranalytics_tools.py` (26 tests)
- Dependency manifest: `pyproject.toml`
